name: Publish to pub.dev

# This workflow publishes to pub.dev with manual control and validation
# Key improvements:
# 1. Manual trigger prevents accidental publishing
# 2. Version extracted from specified release tag (not pubspec.yaml)
# 3. pubspec.yaml updated dynamically from tag
# 4. Validates version doesn't already exist on pub.dev
# 
# Process:
# 1. Create GitHub release with version tag (e.g., v2.0.16)
# 2. Run dry-run-publish.yml for validation
# 3. Manually trigger this workflow with release tag
# 4. Validates and publishes to pub.dev

on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish (e.g., v2.0.16)'
        required: true
        type: string
      
jobs:
  publish:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Clone repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.release_tag }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: master
          flutter-version: 3.29.3
          cache: false 
      - name: Extract version from release tag input
        id: extract-version
        run: |
          TAG_VERSION="${{ github.event.inputs.release_tag }}"
          VERSION="${TAG_VERSION#v}"
          echo "Extracting version from release tag: $TAG_VERSION -> $VERSION"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          
      - name: Verify release exists
        run: |
          TAG_VERSION="${{ github.event.inputs.release_tag }}"
          if ! gh release view "$TAG_VERSION" >/dev/null 2>&1; then
            echo "âŒ Release $TAG_VERSION does not exist!"
            echo "Please create the release first or check the tag name."
            exit 1
          fi
          echo "âœ… Release $TAG_VERSION exists"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate version format
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9\.\-]+)?$ ]]; then
            echo "âŒ Invalid version format: $VERSION"
            echo "Expected format: X.Y.Z or X.Y.Z-suffix"
            exit 1
          fi
          echo "âœ… Version format valid: $VERSION"

      - name: Check if version exists on pub.dev
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          echo "Checking if version $VERSION already exists on pub.dev..."
          
          HTTP_CODE=$(curl -s -w "%{http_code}" -o /dev/null "https://pub.dev/api/packages/axeptio_sdk/versions/$VERSION")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âŒ Version $VERSION already exists on pub.dev!"
            echo "Cannot publish duplicate version. Please create a new release with a different version."
            exit 1
          elif [ "$HTTP_CODE" = "404" ]; then
            echo "âœ… Version $VERSION available for publishing"
          else
            echo "âš ï¸ Could not verify version availability (HTTP $HTTP_CODE)"
            echo "Proceeding with caution..."
          fi

      - name: Update pubspec.yaml with release version
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          echo "Updating pubspec.yaml from release tag version: $VERSION"
          
          # Backup original pubspec.yaml
          cp pubspec.yaml pubspec.yaml.backup
          
          # Update version in pubspec.yaml
          sed -i "s/version: .*/version: $VERSION/" pubspec.yaml
          
          echo "âœ… Updated pubspec.yaml to version: $VERSION"
          echo "Changes:"
          diff pubspec.yaml.backup pubspec.yaml || true

      - name: Install dependencies
        run: flutter pub get
      - name: Analyze
        run: flutter analyze
      - name: Run tests
        run: flutter test
      
      - name: Check Publish Warnings
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          echo "Running dry-run publish for version: $VERSION"
          dart pub publish --dry-run

      - name: Publish to pub.dev
        uses: k-paxian/dart-package-publisher@v1.6
        with:
            accessToken: ${{ secrets.PUB_DEV_PUBLISH_ACCESS_TOKEN }}
            refreshToken: ${{ secrets.PUB_DEV_PUBLISH_REFRESH_TOKEN }}
            flutter: true
            skipTests: true

      - name: Publish Summary
        run: |
          VERSION="${{ steps.extract-version.outputs.version }}"
          TAG_VERSION="${{ github.event.inputs.release_tag }}"
          {
            echo "## ðŸ“¦ Stable Release Summary"
            echo "âœ… Version **$VERSION** published successfully to pub.dev!"
            echo ""
            echo "### Release Information"
            echo "- **Release Tag**: \`$TAG_VERSION\`"
            echo "- **Version**: \`$VERSION\`"
            echo "- **Triggered by**: Manual workflow dispatch"
            echo ""
            echo "### For Users"
            echo '```yaml'
            echo "dependencies:"
            echo "  axeptio_sdk: $VERSION"
            echo '```'
            echo ""
            echo "### Process Completed"
            echo "âœ… Release tag validated and exists"
            echo "âœ… Version extracted from release tag"
            echo "âœ… pubspec.yaml updated dynamically"
            echo "âœ… Version availability verified on pub.dev"
            echo "âœ… Published to pub.dev successfully"
            echo ""
            echo "### Next Steps"
            echo "ðŸŽ‰ **Release is live!**"
            echo "- Package is available on [pub.dev](https://pub.dev/packages/axeptio_sdk)"
            echo "- Update release status if needed (remove draft/pre-release flags)"
            echo "- Announce release to development teams"
          } >> "$GITHUB_STEP_SUMMARY"
